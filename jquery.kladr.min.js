!function(e){function t(e){var t={},r={token:"token",key:"key",type:"contentType",typeCode:"typeCode",name:"query",zip:"zip",withParents:"withParent",oneString:"oneString",limit:"limit"};e.parentType&&e.parentId&&(t[e.parentType+"Id"]=e.parentId);for(var n in e)e.hasOwnProperty(n)&&r.hasOwnProperty(n)&&e[n]&&(t[r[n]]=e[n]);return t}function r(e){window.console&&window.console.error&&window.console.error(e)}e.kladr={},e.kladr.url="http://kladr-api.ru/api.php",e.kladr.type={region:"region",district:"district",city:"city",street:"street",building:"building"},e.kladr.typeCode={city:1,settlement:2,village:4},e.kladr.validate=function(t){switch(t.type){case e.kladr.type.region:case e.kladr.type.district:case e.kladr.type.city:if(t.parentType&&!t.parentId)return r("parentId undefined"),!1;break;case e.kladr.type.street:if(t.parentType!=e.kladr.type.city)return r('parentType must equal "city"'),!1;if(!t.parentId)return r("parentId undefined"),!1;break;case e.kladr.type.building:if(!t.zip){if(t.parentType!=e.kladr.type.street)return r('parentType must equal "street"'),!1;if(!t.parentId)return r("parentId undefined"),!1}break;default:if(!t.oneString)return r("type incorrect"),!1}return t.oneString&&t.parentType&&!t.parentId?(r("parentId undefined"),!1):t.typeCode&&t.type!=e.kladr.type.city?(r('type must equal "city"'),!1):t.limit<1?(r("limit must greater than 0"),!1):!0},e.kladr.api=function(n,a){if(!a)return void r("Callback undefined");if(!e.kladr.validate(n))return void a([]);var i=e.Deferred();i.done(a),i.fail(function(e){r(e),a([])}),e.getJSON(e.kladr.url+"?callback=?",t(n),function(e){i.resolve(e.result||[])}),setTimeout(function(){i.reject("Request error")},3e3)},e.kladr.check=function(t,n){return n?(t.withParents=!1,t.limit=1,void e.kladr.api(t,function(e){n(e&&e.length?e[0]:!1)})):void r("Callback undefined")}}(jQuery),function(e,t){function r(r,n){function d(e,r){return e.isGet?u.get(e.str[0]):(u.set(e),r(),t)}var u=function(){var n=r.data("kladr-data");return n||(n=e.extend({},i,o),r.data("kladr-data",n)),{set:function(e){if(e.obj)for(var t in e.obj)e.obj.hasOwnProperty(t)&&i.hasOwnProperty(t)&&(n[t]=e.obj[t]);else e.str&&!e.isGet&&i.hasOwnProperty(e.str[0])&&(n[e.str[0]]=e.str[1]);r.data("kladr-data",n)},get:function(e){return i.hasOwnProperty(e)||o.hasOwnProperty(e)?n[e]:t},_set:function(e,t){n[e]=t,r.data("kladr-data",n)},_get:function(e){return n.hasOwnProperty(e)?n[e]:t}}}();return d(n,function(){function n(t){var n=e(document.getElementById("kladr_autocomplete"));n.length||(n=e('<div id="kladr_autocomplete"></div>').appendTo(document.body));var i=T("guid");i?(S=n.find(".autocomplete"+i),O=n.find(".spinner"+i),r.off(".kladr"),S.off(".kladr")):(i=a(),I("guid",i),r.attr("autocomplete","off"),S=e('<ul class="autocomplete'+i+' autocomplete" style="display: none;"></ul>').appendTo(n),O=e('<div class="spinner'+i+' spinner" style="display: none;"></div>').appendTo(n),o(),v()),t()}function i(t,r){var n,a,i,o;S.empty();for(var l in t)t.hasOwnProperty(l)&&(n=t[l],a=T("valueFormat")(n,r),i=T("labelFormat")(n,r),o=e('<a data-val="'+a+'">'+i+"</a>"),o.data("kladr-object",n),e("<li></li>").append(o).appendTo(S))}function o(){var e=r.offset(),t=r.outerWidth(),n=r.outerHeight();if(o.top!=e.top||o.left!=e.left||o.width!=t||o.height!=n){o.top=e.top,o.left=e.left,o.width=t,o.height=n,S.css({top:e.top+n+"px",left:e.left});var a=S.outerWidth()-S.width();S.width(t-a);var i=O.width(),l=O.height();O.css({top:e.top+(n-l)/2-1,left:e.left+t-i-2})}}function d(t){if(!(t.which>8&&t.which<46)){if(!y("open_before"))return void s();P(null);var n=r.val();if(!e.trim(n))return C(!1),void s();var a=m(n);if(!y("send_before",a))return void s();k(),y("send"),T("source")(a,function(t){return y("receive"),r.is(":focus")?e.trim(r.val())&&t.length?(i(t,a),o(),g(),S.slideDown(50),void y("open")):(g(),P(null),void s()):(g(),void s())})}}function s(){y("close_before")&&(S.empty().hide(),y("close"))}function p(e){var r=S.find("li.active");switch(e.which){case l.up:r.length?(r.removeClass("active"),r.prev().length&&(r=r.prev())):r=S.find("li").last(),function(){var e=S.scrollTop(),t=S.offset(),n=r.outerHeight(),a=r.offset();a.top-t.top<0&&S.scrollTop(e-n)}(),r.addClass("active"),f();break;case l.down:r.length?(r.removeClass("active"),r.next().length&&(r=r.next())):r=S.find("li").first(),function(){var e=S.scrollTop(),t=S.height(),n=S.offset(),a=r.outerHeight(),i=r.offset();i.top-n.top+a>t&&S.scrollTop(e+a)}(),r.addClass("active"),f();break;case l.enter:s()}return t}function c(){var t=e(this);return t.is("a")&&(t=t.parents("li")),t.addClass("active"),f(),s(),r.focus(),!1}function f(){if(y("select_before")){var e=S.find(".active a");e.length&&(r.val(e.attr("data-val")),C(!1),P(e.data("kladr-object")),y("select",T("current")))}}function h(){function t(e,t){C(t),P(e)}if(T("verify")&&y("check_before")){if(T("current"))return void C(!1);var n=e.trim(r.val());if(!n)return t(null,!1),void y("check",null);var a=m(n);if(a.withParents=!1,a.limit=10,!y("send_before",a))return t(null,!1),void y("check",null);k(),y("send"),T("source")(a,function(n){function i(e,r){g(),t(e,r)}if(y("receive"),!e.trim(r.val()))return void i(null,!1);var o=a.name.toLowerCase(),l=null,d=null;for(var u in n)if(n.hasOwnProperty(u)&&(l=n[u].name.toLowerCase(),o==l)){d=n[u];break}d&&r.val(T("valueFormat")(d,a)),i(d,!d),y("check",d)})}}function v(){function e(){return r.val()?(h(),!!T("current")):!1}var t=0,n=e()||setInterval(function(){(++t>5||e())&&clearInterval(n)},100)}function y(t,n){if(!t)return!0;var a=t.replace(/_([a-z])/gi,function(e,t){return t.toUpperCase()});return r.trigger("kladr_"+t,n),"function"===e.type(T(a))?T(a).call(r.get(0),n)!==!1:!0}function k(){T("spinner")&&T("showSpinner")(O)}function g(){T("spinner")&&T("hideSpinner")(O)}function m(e){var t,r={token:T("token"),key:T("key"),type:T("type"),typeCode:T("typeCode"),name:b(e),parentType:T("parentType"),parentId:T("parentId"),oneString:T("oneString"),withParents:T("withParents"),limit:T("limit")},n=T("parentInput");return r.oneString&&(r.withParents=!0),n&&(t=w(n,r.type),t&&(r.parentType=t.type,r.parentId=t.id)),r}function w(t,r){var n,a=e.kladr.getInputs(t),i=e.kladr.type,o={},l=null;a.each(function(){var t,r=e(this);(t=r.attr("data-kladr-id"))&&(o[r.attr("data-kladr-type")]=t)});for(n in i){if(n==r)return l;i.hasOwnProperty(n)&&o[n]&&(l={type:n,id:o[n]})}return l}function b(e){for(var t,r,n="abcdefghijklmnopqrstuvwxyz",a="Ёё",i="Ее",o=e.toLowerCase(),l="",d=0;d<o.length;d++){if(n.indexOf(o[d])>-1)return C(!0),e;t=e[d],r=a.indexOf(t),l+=r>-1?i[r]:t}return C(!1),l}function P(e){I("current",e),e&&e.id?r.attr("data-kladr-id",e.id):r.removeAttr("data-kladr-id"),T("oneString")&&e&&e.contentType&&r.attr("data-kladr-type",e.contentType)}function C(e){e?r.addClass("kladr-error"):r.removeClass("kladr-error")}function T(e){return u._get(e)}function I(e,t){u._set(e,t)}var S=null,O=null;n(function(){var t=!1;r.attr("data-kladr-type",T("type")||"").attr("data-kladr-one-string",T("oneString")||null).on("keyup.kladr",d).on("keydown.kladr",p).on("blur.kladr",function(){t||(h(),s())}),S.on("touchstart.kladr click.kladr","li, a",function(){t=!0,c.call(this),t=!1}).on("mouseenter.kladr",function(){t=!0}).on("mouseleave.kladr",function(){t=!1}),e(window).on("resize.kladr",o)})})}function n(r){var n={obj:!1,str:!1,isGet:!1};if("object"===e.type(r))return n.obj=r,n;if("string"===e.type(r)){n.str=[];for(var a in arguments)arguments.hasOwnProperty(a)&&(n.str[a]=arguments[a]);n.str[1]===t&&(n.isGet=!0)}return n}function a(){return a.guid||(a.guid=0),++a.guid}var i={token:null,key:null,type:null,typeCode:null,parentType:null,parentId:null,limit:10,oneString:!1,withParents:!1,parentInput:null,verify:!1,spinner:!0,open:null,close:null,send:null,receive:null,select:null,check:null,openBefore:null,closeBefore:null,sendBefore:null,selectBefore:null,checkBefore:null,source:function(t,r){e.kladr.api(t,r)},labelFormat:function(t,r){var n;if(r.oneString)return t.parents?(n=e.extend(!0,[],t.parents),n.push(t),e.kladr.buildAddress(n)):(t.typeShort?t.typeShort+". ":"")+t.name;var a,i,o,l,d="";return t.typeShort&&(d+=t.typeShort+". "),a=t.name,i=a.toLowerCase(),o=r.name.toLowerCase(),l=i.indexOf(o),l=l>0?l:0,o.length<i.length?(d+=a.substr(0,l),d+="<strong>"+a.substr(l,o.length)+"</strong>",d+=a.substr(l+o.length,i.length-o.length-l)):d+="<strong>"+a+"</strong>",d},valueFormat:function(t,r){var n;return r.oneString?t.parents?(n=e.extend(!0,[],t.parents),n.push(t),e.kladr.buildAddress(n)):(t.typeShort?t.typeShort+". ":"")+t.name:t.name},showSpinner:function(e){var t=-.2,r=setInterval(function(){return e.is(":visible")?(e.css("background-position","0% "+t+"%"),t+=5.555556,void(t>95&&(t=-.2))):(clearInterval(r),void(r=null))},30);e.show()},hideSpinner:function(e){e.hide()}},o={current:null},l={up:38,down:40,enter:13};e.kladr=e.extend(e.kladr,{setDefault:function(e,t){var r=n(e,t);if(r.obj)for(var a in r.obj)i.hasOwnProperty(a)&&(i[a]=r.obj[a]);else r.str&&!r.isGet&&i.hasOwnProperty(r.str[0])&&(i[r.str[0]]=r.str[1])},getDefault:function(e){return i.hasOwnProperty(e)?i[e]:t},getInputs:function(t){var r=e(),n="[data-kladr-type]";return e(t||document.body).each(function(){var t=e(this);r=r.add(t.is(n)?t:t.find(n))}),r},getAddress:function(t,r){var n,a=e.kladr.getInputs(t),i=e.kladr.type,o={},l={};a.each(function(){var t,r,n,a=e(this);if(a.attr("data-kladr-id"))if(t=a.kladr("current"),a.attr("data-kladr-one-string")&&t.parents){r=e.extend(!0,[],t.parents),r.push(t);for(n in r)r.hasOwnProperty(n)&&(o[r[n].contentType]=r[n])}else o[a.attr("data-kladr-type")]=t;else o[a.attr("data-kladr-type")]=a.val()});for(n in i)i.hasOwnProperty(n)&&o[n]&&(l[n]=o[n]);return(r||e.kladr.buildAddress)(l)},buildAddress:function(t){var r,n,a=[],i=!1,o="",l="",d="",u="";for(r in t)if(t.hasOwnProperty(r)){if("object"===e.type(t[r])){for(i=!1,n=0;n<a.length;n++)if(a[n]==t[r].id){i=!0;break}if(i)continue;a.push(t[r].id),d=t[r].name,u=t[r].typeShort+". ",l=t[r].zip||l}else d=t[r],u="";o&&(o+=", "),o+=u+d}return o=(l?l+", ":"")+o}}),e.fn.kladr=function(a,i){var o=n(a,i),l=t;return this.each(function(){var n=r(e(this),o);return o.isGet?(l=n,!1):t}),o.isGet?l:this}}(jQuery),function(e){e.fn.kladrZip=function(t){var r=e(t||document.body);return this.keydown(function(t){var r=t.charCode||t.keyCode||0,n=8==r||9==r||13==r||46==r||110==r||190==r||r>=35&&40>=r||r>=96&&105>=r;return e(this).val().length>=6?n:n||r>=48&&57>=r}),this.keyup(function(){function t(e){e?n.addClass("kladr-error"):n.removeClass("kladr-error")}var n=e(this),a=n.val();return a?void e.kladr.api({type:e.kladr.type.building,zip:a,withParents:!0,limit:1},function(n){var a,i,o,l=n.length&&n[0];if(n=[],l){t(!1),l.parents&&(n=e.extend(!0,[],l.parents)),n.push(l);for(a in n)n.hasOwnProperty(a)&&(i=r.find('[data-kladr-type="'+n[a].contentType+'"]'),o=i.kladr("source"),function(){var e=n[a];i.val(e.name).kladr("source",function(t,r){r([e])})}(),i.trigger("blur"),i.kladr("source",o))}else t(!0)}):void t(!1)}),this}}(jQuery);