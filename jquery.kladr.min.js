(function(a){a.kladr={};a.kladr.url="http://kladr-api.ru/api.php";a.kladr.type={region:"region",district:"district",city:"city",street:"street",building:"building"};a.kladr.api=function(c,e){var b={};if(c.token){b.token=c.token}if(c.key){b.key=c.key}if(c.type){b.contentType=c.type}if(c.name){b.query=c.name}if(c.parentType&&c.parentId){b[c.parentType+"Id"]=c.parentId}if(c.withParents){b.withParent=1}b.limit=c.limit?c.limit:2000;var d=false;a.getJSON(a.kladr.url+"?callback=?",b,function(f){if(d){return}d=true;e&&e(f.result)});setTimeout(function(){if(d){return}d=true;console.error("Request error");e&&e([])},5000)};a.kladr.check=function(b,c){b.withParents=false;b.limit=1;a.kladr.api(b,function(d){if(d&&d.length){c&&c(d[0])}else{c&&c(false)}})}})(jQuery);(function(b,a){b.fn.kladr=function(d,e){this.each(function(){c(b(this),d,e)});function c(A,m,s){var v=null;var z=null;var y=null;var h={token:null,key:null,type:null,parentType:null,parentId:null,limit:10,withParents:false,verify:false,showSpinner:true,arrowSelect:true,current:null,open:null,close:null,send:null,received:null,select:null,check:null,source:function(F,G){var E={token:y.token,key:y.token,type:y.type,name:F,parentType:y.parentType,parentId:y.parentId,withParents:y.withParents,limit:y.limit};b.kladr.api(E,G)},labelFormat:function(H,F){var E="";var I=H.name.toLowerCase();F=F.toLowerCase();var G=I.indexOf(F);G=G>0?G:0;if(H.typeShort){E+=H.typeShort+". "}if(F.length<H.name.length){E+=H.name.substr(0,G);E+="<strong>"+H.name.substr(G,F.length)+"</strong>";E+=H.name.substr(G+F.length,H.name.length-F.length-G)}else{E+="<strong>"+H.name+"</strong>"}return E},valueFormat:function(F,E){return F.name}};var B={up:38,down:40,esc:27,enter:13};var r=null;return q(m,s,function(){var E=false;g();C();A.keyup(w);A.keydown(f);A.change(function(){if(!E){i()}});A.blur(function(){if(!E){D()}});v.on("click","li, a",l);v.on("mouseenter","li",function(){var G=b(this);v.find("li.active").removeClass("active");G.addClass("active");var F=G.find("a").data("kladr-object");u("preselect",F);E=true});v.on("mouseleave","li",function(){b(this).removeClass("active");E=false});b(window).resize(C)});function q(F,G,H){y=A.data("kladr-options");if(G!==a){y[F]=G;A.data("kladr-options",y);return A}if(b.type(F)==="string"){if(!y){return null}return y[F]}if(y){return A}y=h;if(b.type(F)==="object"){for(var E in F){y[E]=F[E]}}A.data("kladr-options",y);H&&H();return A}function g(){var F=b(document.getElementById("kladr_autocomplete"));var E=A.attr("name");if(!F.length){F=b('<div id="kladr_autocomplete"></div>').appendTo("body")}A.attr("autocomplete","off");v=b('<ul class="kladr_autocomplete_'+E+'" style="display: none;"></ul>');v.appendTo(F);z=b('<div class="spinner kladr_autocomplete_'+E+'_spinner" class="spinner" style="display: none;"></div>');z.appendTo(F)}function j(I,K){v.empty();for(var F in I){var L=I[F];var E=y.valueFormat(L,K);var G=y.labelFormat(L,K);var H=b('<a data-val="'+E+'">'+G+"</a>");H.data("kladr-object",L);var J=b("<li></li>").append(H);J.appendTo(v)}}function C(){var E=A.offset();var G=A.outerWidth();var F=A.outerHeight();v.css({top:E.top+F+"px",left:E.left});var J=v.outerWidth()-v.width();v.width(G-J);var H=z.width();var I=z.height();z.css({top:E.top+(F-I)/2-1,left:E.left+G-H-2,})}function w(F){if((F.which>8)&&(F.which<46)){return}if(!x()){return}var E=o(A.val());if(!b.trim(E)){D();return}t();u("send");y.source(E,function(G){p();u("received");if(!A.is(":focus")){D();return}if(!b.trim(A.val())||!G.length){D();return}j(G,E);C();v.slideDown(50);u("open")})}function D(){k();v.hide();u("close")}function x(){switch(y.type){case b.kladr.type.region:case b.kladr.type.district:case b.kladr.type.city:if(y.parentType&&!y.parentId){console.error("parentType is defined and parentId in not");return false}break;case b.kladr.type.street:if(y.parentType!=b.kladr.type.city){console.error('For street parentType must equal "city"');return false}if(!y.parentId){console.error("For street parentId must defined");return false}break;case b.kladr.type.building:if(y.parentType!=b.kladr.type.street){console.error('For building parentType must equal "street"');return false}if(!y.parentId){console.error("For building parentId must defined");return false}break;default:console.error('type must defined and equal "region", "district", "city", "street" or "building"');return false}if(y.limit<1){console.error("limit must greater than 0");return false}return true}function k(){var E=v.find(".active a");if(!E.length){return}A.val(E.attr("data-val"));y.current=E.data("kladr-object");A.data("kladr-options",y);u("select",y.current)}function f(F){var E=v.find("li.active");switch(F.which){case B.up:if(E.length){E.removeClass("active");E=E.prev()}else{E=v.find("li").last()}E.addClass("active");var G=E.find("a").data("kladr-object");u("preselect",G);if(y.arrowSelect){k()}break;case B.down:if(E.length){E.removeClass("active");E=E.next()}else{E=v.find("li").first()}E.addClass("active");var G=E.find("a").data("kladr-object");u("preselect",G);if(y.arrowSelect){k()}break;case B.esc:E.removeClass("active");D();break;case B.enter:if(!y.arrowSelect){k()}E.removeClass("active");D();return false}}function l(){var E=b(this);if(E.is("li")){E=E.find("a")}k(E);D();A.focus();return false}function i(){if(!y.verify){return}if(!x()){return}var E=o(A.val());if(!b.trim(E)){return}t();u("send");y.source(E,function(H){p();u("received");var I=null;for(var G=0;G<H.length;G++){var F=E.toLowerCase();var J=H[G].name.toLowerCase();if(F==J){I=H[G];break}}if(I){A.val(y.valueFormat(I,E))}y.current=I;A.data("kladr-options",y);u("check",y.current)})}function o(H){var I="1234567890qazwsxedcrfvtgbyhnujmik,ol.p;[']- QAZWSXEDCRFVTGBYHNUJMIK<OL>P:{\"} ";var F="1234567890йфяцычувскамепинртгоьшлбщдюзжхэъ- ЙФЯЦЫЧУВСКАМЕПИНРТГОЬШЛБЩДЮЗЖХЭЪ ";var K="";var G;var J;for(var E=0;E<H.length;E++){G=H[E];J=I.indexOf(G);if(J>-1){K+=F[J];continue}K+=G}return K}function u(E,F){if(!E){return}A.trigger("kladr_"+E,F);if(y[E]){y[E].call(A.get(0),F)}}function n(){if(r){return}var E=-0.2;r=setInterval(function(){if(!z.is(":visible")){clearInterval(r);r=null;return}z.css("background-position","0% "+E+"%");E+=5.555556;if(E>95){E=-0.2}},30)}function t(){if(y.showSpinner){z.show();n()}}function p(){z.hide()}}}})(jQuery);